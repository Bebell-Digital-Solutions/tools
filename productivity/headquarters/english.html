<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headquarters</title>

     <link rel="icon" href="https://bucket.mlcdn.com/a/3336/3336910/images/ad4c22e5b232bd1ab5a5e62d15be9ad96e354811.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #df1783;
            --secondary: #8c318f;
            --accent: rgba(255,255,255,0.1);
            --light: #f8f9fa;
            --dark-bg: #1a202c;
            --dark-card: #2d3748;
            --dark-text: #e2e8f0;
        }

        html.dark {
            --light: var(--dark-bg);
            --dark-text: #e2e8f0;
        }


                
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            min-height: 100vh;
            background-color: #eef2f7;
            color: #333;
        }

        html.dark body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .sidebar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: background 0.5s ease;
        }

        .nav-item {
            transition: all 0.3s;
        }

        .nav-item:hover {
            background-color: var(--accent);
        }

        .nav-item.active {
            background-color: var(--accent);
            font-weight: bold;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        html.dark .card {
            background: var(--dark-card);
        }

        input, select, textarea {
            background-color: #fbfbfb;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            color: #333;
            transition: all 0.2s;
        }
        html.dark input, html.dark select, html.dark textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: var(--dark-text);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 2px rgba(223, 23, 131, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
            cursor: pointer;
            border: none;
            padding: 10px 20px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .bg-primary { background-color: var(--primary); }

        /* Pomodoro Styles */
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: transparent; }
            50% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.6); border-color: #ef4444; }
        }
        
        .pomodoro-warning {
            animation: pulse-red 1s infinite;
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
        }
        html.dark .calendar-grid { background-color: #4a5568; }

        .calendar-day, .calendar-header {
            background-color: white;
            padding: 8px;
        }
        html.dark .calendar-day, html.dark .calendar-header { background-color: var(--dark-card); }
        .calendar-header { font-weight: bold; text-align: center; }

        .calendar-day { min-height: 120px; }
        .calendar-day.other-month { background-color: #f1f5f9; }
        html.dark .calendar-day.other-month { background-color: #1a202c; color: #718096; }

        .calendar-task {
            background-color: #fecdd3;
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }
        html.dark .calendar-task { background-color: #b91c1c; color: white; }

        /* Modal Styles */
        #modal-container {
            transition: opacity 0.3s ease;
        }
        #modal-content {
            transition: transform 0.3s ease;
        }

        .save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #22c55e;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .save-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .section-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 14px;
        }
        html.dark .section-footer {
            border-top-color: #4a5568;
            color: #a0aec0;
        }
        
        /* Kanban Styles */
        .kanban-task {
            cursor: grab;
        }
        .kanban-task.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .kanban-col.drag-over {
            background-color: var(--accent);
            border-radius: 0.5rem;
        }
        html.dark .kanban-col.drag-over {
             background-color: rgba(255, 255, 255, 0.05);
        }

        /* Flip Clock Styles */
        .flip-clock-digit {
            background-color: var(--primary);
            color: white;
            font-family: monospace;
            border-radius: 4px;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.4rem;
            height: 2.2rem;
            line-height: 2.2rem;
            font-size: 1.25rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            perspective: 400px;
        }
        .flip-clock-digit::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(0,0,0,0.3);
            box-shadow: 0 1px 0 rgba(255,255,255,0.1);
        }
        .animate-flip {
            animation: flipKey 0.6s ease-in-out;
        }
        @keyframes flipKey {
            0% { transform: rotateX(0deg); }
            50% { transform: rotateX(90deg); opacity: 0.7; }
            100% { transform: rotateX(0deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg flex h-screen">

 

    <div class="sidebar w-64 flex-shrink-0 flex flex-col p-6">
        <div class="mb-10">
            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-4">
                <i data-lucide="zap" class="w-8 h-8 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Headquarters</h1>
            <p class="text-white/80 text-sm leading-relaxed">Your productivity command center.</p>
        </div>
        
        <nav class="flex-grow space-y-2">
            <div id="nav-dashboard" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="dashboard"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></div>
            <div id="nav-tasks" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="tasks"><i data-lucide="check-square"></i><span>Tasks</span></div>
            <div id="nav-projects" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="projects"><i data-lucide="folder-kanban"></i><span>Projects</span></div>
            <div id="nav-notes" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="notes"><i data-lucide="notebook-pen"></i><span>Notes</span></div>
            <div id="nav-calendar" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="calendar"><i data-lucide="calendar-days"></i><span>Calendar</span></div>
            
            <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" 
                 data-view="iframe-view" 
                 data-iframe-url="https://bebell-digital-solutions.github.io/aiba-deepseek/es-v03" 
                 data-iframe-title="AI Assistant">
                <i data-lucide="bot"></i><span>AI Assistant</span>
            </div>
        </nav>

        <div class="space-y-3 mt-auto">
             <button id="settings-btn" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent text-left">
                <i data-lucide="settings" class="w-5 h-5"></i><span>Settings</span>
            </button>
            <button id="theme-toggle" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent text-left">
                <i data-lucide="sun" class="w-5 h-5"></i><span>Light Mode</span>
            </button>
            <a href="https://www.notion.so/templates" target="_blank" class="flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent">
                 <i data-lucide="download" class="w-5 h-5"></i><span>Notion Templates</span>
            </a>
        </div>
    </div>

    <main class="flex-grow p-8 overflow-y-auto relative">
        
        <section id="dashboard" class="section space-y-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-4xl font-bold">Dashboard</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Here is your productivity summary for today.</p>
                </div>
                
                <div class="flex flex-col items-end md:items-center">
                    <span class="text-[10px] uppercase tracking-widest font-light mb-1 text-gray-500 dark:text-gray-400">Pomodoro</span>
                    <div id="pomodoro-widget" class="card flex items-center gap-4 px-6 py-3 transition-all transform hover:scale-105 border-2 border-transparent">
                        <div id="pomodoro-display" class="flex items-center gap-1">
                            <div id="digit-m1" class="flip-clock-digit">2</div>
                            <div id="digit-m2" class="flip-clock-digit">5</div>
                            <div class="font-bold text-gray-400 dark:text-gray-500 px-0.5">:</div>
                            <div id="digit-s1" class="flip-clock-digit">0</div>
                            <div id="digit-s2" class="flip-clock-digit">0</div>
                        </div>
                        <button id="pomodoro-btn" class="p-1.5 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50" title="Start/Pause">
                            <i data-lucide="play" class="w-5 h-5 fill-current"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button id="btn-add-task" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> Add New Task
                </button>
                <button id="btn-add-note" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> Add Quick Note
                </button>
                <button id="btn-add-project" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> Add New Project
                </button>
            </div>

             <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="dashboard-stats">
                </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6 flex flex-col">
                    <h2 class="text-xl font-bold mb-4 flex-shrink-0">Task Completion Status</h2>
                    <div class="relative flex-grow min-h-[250px]">
                        <canvas id="task-completion-chart"></canvas>
                    </div>
                </div>
                <div class="card p-6 flex flex-col">
                    <h2 class="text-xl font-bold mb-4 flex-shrink-0">This Week's Deadlines</h2>
                    <div id="weekly-deadlines" class="flex-grow overflow-y-auto max-h-[268px]">
                        </div>
                </div>
            </div>

            <div class="card p-6">
                 <h2 class="text-xl font-bold mb-4">Task Overview</h2>
                 <div id="dashboard-tasks" class="text-gray-600 dark:text-gray-300">Loading tasks...</div>
            </div>

            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4">Calendar Preview</h2>
                <div id="dashboard-calendar-preview">Loading calendar...</div>
            </div>
        </section>

        <section id="tasks" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Tasks</h1>
                <button id="add-task-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> Add New Task
                </button>
            </div>
            <div id="tasks-filter-container" class="card p-4 mb-6"></div>
            <div id="tasks-list" class="space-y-4"></div>
        </section>

        <section id="projects" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Projects</h1>
                 <button id="add-project-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> Add New Project
                </button>
            </div>
            <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="notes" class="section hidden">
             <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Notes</h1>
                 <button id="add-note-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> Add New Note
                </button>
            </div>
            <div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="calendar" class="section hidden space-y-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h1 class="text-4xl font-bold">Calendar</h1>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                         <button id="sync-google-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white text-sm py-2">
                             <i data-lucide="calendar-plus"></i> Sync with Google
                        </button>
                        <button id="download-ics-btn" class="btn bg-green-500 hover:bg-green-600 text-white text-sm py-2">
                           <i data-lucide="download-cloud"></i> Download .ICS
                        </button>
                    </div>
                    <div class="flex items-center border rounded-lg p-1 bg-gray-200 dark:bg-gray-700">
                        <button id="calendar-view-month" class="px-3 py-1 text-sm rounded-md">Month</button>
                        <button id="calendar-view-week" class="px-3 py-1 text-sm rounded-md">Week</button>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">Today's Tasks</h2>
                <div id="calendar-today-tasks"></div>
            </div>

            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                     <button id="calendar-prev" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="chevron-left"></i></button>
                     <h2 id="calendar-title" class="text-2xl font-bold"></h2>
                     <button id="calendar-next" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="chevron-right"></i></button>
                </div>
                <div id="calendar-container"></div>
            </div>
        </section>
        
        <section id="iframe-view" class="section hidden h-full flex flex-col">
            <h1 id="iframe-title" class="text-4xl font-bold mb-6 flex-shrink-0"></h1>
            <div class="flex-grow rounded-xl overflow-hidden shadow-lg">
                <iframe id="content-iframe" class="w-full h-full border-0" src="about:blank"></iframe>
            </div>
        </section>

        <section id="kanban-view" class="section hidden h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h1 class="text-4xl font-bold truncate pr-4">Kanban: <span id="kanban-project-title"></span></h1>
                <button id="back-to-projects-btn" class="btn bg-gray-200 dark:bg-gray-600 dark:text-white">
                    <i data-lucide="arrow-left"></i>
                    <span class="hidden sm:inline">Back to Projects</span>
                </button>
            </div>
            <div id="kanban-board" class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-6 overflow-x-auto">
                <div class="kanban-col bg-gray-200/50 dark:bg-dark-bg/50 p-4 rounded-lg flex flex-col">
                    <h2 class="font-bold text-lg mb-4 pb-2 border-b-2 border-red-500 flex-shrink-0">Pending</h2>
                    <div id="kanban-pending" class="kanban-tasks-container space-y-4 min-h-[200px] flex-grow overflow-y-auto"></div>
                </div>
                <div class="kanban-col bg-gray-200/50 dark:bg-dark-bg/50 p-4 rounded-lg flex flex-col">
                    <h2 class="font-bold text-lg mb-4 pb-2 border-b-2 border-yellow-500 flex-shrink-0">In Progress</h2>
                    <div id="kanban-progress" class="kanban-tasks-container space-y-4 min-h-[200px] flex-grow overflow-y-auto"></div>
                </div>
                <div class="kanban-col bg-gray-200/50 dark:bg-dark-bg/50 p-4 rounded-lg flex flex-col">
                    <h2 class="font-bold text-lg mb-4 pb-2 border-b-2 border-green-500 flex-shrink-0">Done</h2>
                    <div id="kanban-done" class="kanban-tasks-container space-y-4 min-h-[200px] flex-grow overflow-y-auto"></div>
                </div>
            </div>
        </section>

        <footer class="section-footer">
            <p>Developed with ðŸ’– by <a href="https://bebelldigitalsolutions.com" target="_blank" rel="noopener noreferrer" class="hover:underline"><strong style="color:var(--primary);">Bebell Digital Solutions</strong></a></p>
            <p>Copyright Â© 2025 â€¢ All rights reserved</p>
        </footer>
    </main>

    <div id="modal-container" class="fixed inset-0 z-50 bg-black/60 hidden items-center justify-center p-4 opacity-0">
        <div id="modal-content" class="card w-full max-w-2xl transform -translate-y-10">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-600">
                <h2 id="modal-title" class="text-2xl font-bold">Modal Title</h2>
                <button id="modal-close" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="x"></i></button>
            </div>
            <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto">
            </div>
        </div>
    </div>

    <div class="save-notification" id="saveNotification">
        Data saved successfully!
    </div>


<script>(function(d, s, id){
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = 'https://api.helpdesk.icu/widget/6cb4c417-1da5-31ec-ae0d-b1f79dad581f?r=' + encodeURIComponent(window.location);
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'contactus-jssdk'));</script>

    
    
    <script>
        (function() {
            'use strict';

            // --- STATE MANAGEMENT & GLOBALS ---
            const state = {
                tasks: [],
                projects: [],
                notes: [],
                activeView: 'dashboard',
                activeProjectId: null, // For Kanban view
                calendarDate: new Date(),
                calendarView: 'month', // 'month' or 'week'
                taskSearchQuery: '',
                activeTagFilter: null,
                primaryColor: '#df1783',
                secondaryColor: '#8c318f',
                language: 'en'
            };
            let taskCompletionChart = null;

            // --- TRANSLATION DATA ---
            const translations = {
                en: {
                    // Sidebar
                    "dashboard": "Dashboard",
                    "tasks": "Tasks",
                    "projects": "Projects",
                    "notes": "Notes",
                    "calendar": "Calendar",
                    "ai_assistant": "AI Assistant",
                    "settings": "Settings",
                    "theme_light": "Light Mode",
                    "theme_dark": "Dark Mode",
                    "notion_templates": "Notion Templates",
                    "tagline": "Your productivity command center.",
                    
                    // Dashboard
                    "daily_summary": "Here is your productivity summary for today.",
                    "pending_tasks": "Pending Tasks",
                    "active_projects": "Active Projects",
                    "total_notes": "Total Notes",
                    "task_completion": "Task Completion Status",
                    "weekly_deadlines": "This Week's Deadlines",
                    "task_overview": "Task Overview",
                    "calendar_preview": "Calendar Preview",
                    "no_deadlines": "No deadlines this week!",
                    "no_pending": "No pending tasks. Good job!",
                    "no_upcoming": "No upcoming deadlines.",
                    "add_new_task": "Add New Task",
                    "add_quick_note": "Add Quick Note",
                    "add_new_project": "Add New Project",
                    "completed": "Completed",
                    "pending": "Pending",
                    "todays_tasks": "Today's Tasks",
                    "no_tasks_today": "No tasks scheduled for today.",
                    
                    // Generic / Buttons
                    "add": "Add",
                    "save_changes": "Save Changes",
                    "cancel": "Cancel",
                    "delete": "Delete",
                    "edit": "Edit",
                    "confirm": "Confirm",
                    "search_placeholder": "Search tasks by title...",
                    "filter_tag": "Filter by Tag:",
                    "clear_filter": "Clear Filter",
                    "back_to_projects": "Back to Projects",
                    "developed_by": "Developed with ðŸ’– by",
                    "delete_task_confirm": "Are you sure you want to delete this task?",
                    "delete_project_confirm": "Are you sure you want to delete this project? This will remove the project from all associated tasks, but will not delete the tasks themselves.",
                    "delete_note_confirm": "Are you sure you want to delete this note?",
                    
                    // Forms
                    "title": "Title",
                    "description": "Description",
                    "due_date": "Due Date",
                    "project": "Project",
                    "priority": "Priority",
                    "urgency": "Urgency",
                    "importance": "Importance",
                    "tags_label": "Tags (comma separated)",
                    "content": "Content",
                    "project_name": "Project Name",
                    "highest": "Highest",
                    "high": "High",
                    "medium": "Medium",
                    "low": "Low",
                    "urgent": "Urgent",
                    "not_urgent": "Not Urgent",
                    "important": "Important",
                    "not_important": "Not Important",
                    "none": "None",

                    // Settings
                    "settings_title": "Personalization Settings",
                    "settings_desc": "Customize the interface language and colors.",
                    "language_label": "Language / Idioma",
                    "primary_color": "Primary Color",
                    "secondary_color": "Secondary Color",
                    "settings_saved": "Settings saved!",

                    // Kanban
                    "kanban_pending": "Pending",
                    "kanban_progress": "In Progress",
                    "kanban_done": "Done",

                    // Calendar
                    "month": "Month",
                    "week": "Week",
                    "sync_google": "Sync with Google",
                    "download_ics": "Download .ICS"
                },
                es: {
                    // Sidebar
                    "dashboard": "Panel de Control",
                    "tasks": "Tareas",
                    "projects": "Proyectos",
                    "notes": "Notas",
                    "calendar": "Calendario",
                    "ai_assistant": "Asistente IA",
                    "settings": "ConfiguraciÃ³n",
                    "theme_light": "Modo Claro",
                    "theme_dark": "Modo Oscuro",
                    "notion_templates": "Plantillas Notion",
                    "tagline": "Tu centro de mando de productividad.",

                    // Dashboard
                    "daily_summary": "AquÃ­ estÃ¡ tu resumen de productividad para hoy.",
                    "pending_tasks": "Tareas Pendientes",
                    "active_projects": "Proyectos Activos",
                    "total_notes": "Notas Totales",
                    "task_completion": "Estado de FinalizaciÃ³n",
                    "weekly_deadlines": "Fechas LÃ­mite de esta Semana",
                    "task_overview": "Resumen de Tareas",
                    "calendar_preview": "Vista Previa del Calendario",
                    "no_deadlines": "Â¡No hay fechas lÃ­mite esta semana!",
                    "no_pending": "No hay tareas pendientes. Â¡Buen trabajo!",
                    "no_upcoming": "No hay prÃ³ximas fechas lÃ­mite.",
                    "add_new_task": "Nueva Tarea",
                    "add_quick_note": "Nota RÃ¡pida",
                    "add_new_project": "Nuevo Proyecto",
                    "completed": "Completadas",
                    "pending": "Pendientes",
                    "todays_tasks": "Tareas de Hoy",
                    "no_tasks_today": "No hay tareas programadas para hoy.",

                    // Generic / Buttons
                    "add": "AÃ±adir",
                    "save_changes": "Guardar Cambios",
                    "cancel": "Cancelar",
                    "delete": "Eliminar",
                    "edit": "Editar",
                    "confirm": "Confirmar",
                    "search_placeholder": "Buscar tareas por tÃ­tulo...",
                    "filter_tag": "Filtrar por etiqueta:",
                    "clear_filter": "Borrar Filtro",
                    "back_to_projects": "Volver a Proyectos",
                    "developed_by": "Desarrollado con ðŸ’– por",
                    "delete_task_confirm": "Â¿EstÃ¡s seguro de que deseas eliminar esta tarea?",
                    "delete_project_confirm": "Â¿EstÃ¡s seguro de que deseas eliminar este proyecto? Esto eliminarÃ¡ el proyecto de todas las tareas asociadas, pero no eliminarÃ¡ las tareas en sÃ­.",
                    "delete_note_confirm": "Â¿EstÃ¡s seguro de que deseas eliminar esta nota?",

                    // Forms
                    "title": "TÃ­tulo",
                    "description": "DescripciÃ³n",
                    "due_date": "Fecha de Vencimiento",
                    "project": "Proyecto",
                    "priority": "Prioridad",
                    "urgency": "Urgencia",
                    "importance": "Importancia",
                    "tags_label": "Etiquetas (separadas por coma)",
                    "content": "Contenido",
                    "project_name": "Nombre del Proyecto",
                    "highest": "Muy Alta",
                    "high": "Alta",
                    "medium": "Media",
                    "low": "Baja",
                    "urgent": "Urgente",
                    "not_urgent": "No Urgente",
                    "important": "Importante",
                    "not_important": "No Importante",
                    "none": "Ninguno",

                    // Settings
                    "settings_title": "ConfiguraciÃ³n de PersonalizaciÃ³n",
                    "settings_desc": "Personaliza el idioma y los colores de la interfaz.",
                    "language_label": "Language / Idioma",
                    "primary_color": "Color Primario",
                    "secondary_color": "Color Secundario",
                    "settings_saved": "Â¡ConfiguraciÃ³n guardada!",

                    // Kanban
                    "kanban_pending": "Pendiente",
                    "kanban_progress": "En Progreso",
                    "kanban_done": "Hecho",

                    // Calendar
                    "month": "Mes",
                    "week": "Semana",
                    "sync_google": "Sincronizar con Google",
                    "download_ics": "Descargar .ICS"
                }
            };

            // Helper function to get text
            function t(key) {
                const lang = state.language || 'en';
                return translations[lang][key] || key; // Fallback to key if missing
            }

            // --- POMODORO LOGIC ---
            const pomodoro = {
                timeLeft: 25 * 60,
                isRunning: false,
                interval: null,
                widget: null,
                btn: null,

                init() {
                    this.widget = document.getElementById('pomodoro-widget');
                    this.btn = document.getElementById('pomodoro-btn');
                    
                    if (this.btn) {
                        this.btn.addEventListener('click', () => this.toggle());
                    }
                    this.render();
                },

                toggle() {
                    if (this.timeLeft <= 0) {
                        this.reset();
                        this.start();
                    } else if (this.isRunning) {
                        this.pause();
                    } else {
                        this.start();
                    }
                },

                start() {
                    if(this.isRunning) return;
                    this.isRunning = true;
                    this.updateIcon('pause');
                    this.interval = setInterval(() => {
                        this.timeLeft--;
                        this.render();
                        
                        // Blinking warning in last minute (<= 60 seconds and > 0)
                        if (this.timeLeft <= 60 && this.timeLeft > 0) {
                            this.widget.classList.add('pomodoro-warning');
                        } else {
                            this.widget.classList.remove('pomodoro-warning');
                        }

                        if (this.timeLeft <= 0) {
                            this.stop();
                        }
                    }, 1000);
                },

                pause() {
                    this.isRunning = false;
                    clearInterval(this.interval);
                    this.updateIcon('play');
                    this.widget.classList.remove('pomodoro-warning');
                },
                
                stop() {
                    this.pause();
                    this.timeLeft = 0;
                    this.render();
                    this.updateIcon('rotate-ccw'); // Show restart icon
                },

                reset() {
                    this.timeLeft = 25 * 60;
                    this.render();
                    this.widget.classList.remove('pomodoro-warning');
                    this.updateIcon('play');
                },

                updateIcon(name) {
                     this.btn.innerHTML = `<i data-lucide="${name}" class="w-5 h-5 fill-current"></i>`;
                     if(window.lucide) window.lucide.createIcons({ root: this.btn.parentNode });
                },

                updateDigit(id, val) {
                    const el = document.getElementById(id);
                    if (el && el.textContent !== val) {
                        el.textContent = val;
                        el.classList.remove('animate-flip');
                        void el.offsetWidth; // trigger reflow
                        el.classList.add('animate-flip');
                    }
                },

                render() {
                    const m = Math.floor(this.timeLeft / 60).toString().padStart(2, '0');
                    const s = (this.timeLeft % 60).toString().padStart(2, '0');
                    
                    this.updateDigit('digit-m1', m[0]);
                    this.updateDigit('digit-m2', m[1]);
                    this.updateDigit('digit-s1', s[0]);
                    this.updateDigit('digit-s2', s[1]);
                }
            };

            // --- DATABASE SERVICE ---
            const dbService = {
                db: null,
                init() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('HeadquartersDB', 2);
                        request.onerror = e => reject('Error opening DB', e);
                        request.onsuccess = e => {
                            this.db = e.target.result;
                            resolve();
                        };
                        request.onupgradeneeded = e => {
                            const db = e.target.result;
                            const stores = ['tasks', 'projects', 'notes'];
                            stores.forEach(s => {
                                if (!db.objectStoreNames.contains(s)) {
                                    db.createObjectStore(s, { keyPath: 'id' });
                                }
                            });
                        };
                    });
                },
                async add(storeName, item) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readwrite');
                        tx.oncomplete = () => resolve();
                        tx.onerror = e => reject(`Transaction error in ${storeName}`, e.target.error);
                        const store = tx.objectStore(storeName);
                        store.put(item).onerror = e => reject(`Error adding/updating in ${storeName}`, e.target.error);
                    });
                },
                async getAll(storeName) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readonly');
                        const store = tx.objectStore(storeName);
                        const req = store.getAll();
                        req.onsuccess = e => resolve(e.target.result);
                        req.onerror = e => reject(`Error getting all from ${storeName}`, e.target.error);
                    });
                },
                async delete(storeName, key) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readwrite');
                        tx.oncomplete = () => resolve();
                        tx.onerror = e => reject(`Transaction error in ${storeName}`, e.target.error);
                        const store = tx.objectStore(storeName);
                        store.delete(key).onerror = e => reject(`Error deleting in ${storeName}`, e.target.error);
                    });
                },
            };

            // --- DOM SELECTORS ---
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);
            
            // --- UI & THEME FUNCTIONS ---
            function applyColors(primary, secondary) {
                const root = document.documentElement;
                state.primaryColor = primary;
                state.secondaryColor = secondary;
                root.style.setProperty('--primary', primary);
                root.style.setProperty('--secondary', secondary);
            }

            function saveColorsToStorage(primary, secondary) {
                localStorage.setItem('headquarters-colors', JSON.stringify({ primary, secondary }));
            }

            function loadColorsFromStorage() {
                const savedColors = localStorage.getItem('headquarters-colors');
                if (savedColors) {
                    const { primary, secondary } = JSON.parse(savedColors);
                    applyColors(primary, secondary);
                } else {
                    // Apply default colors if none are saved
                    applyColors(state.primaryColor, state.secondaryColor);
                }
            }


            // --- RENDER FUNCTIONS & HELPERS ---
            function getPriorityInfo(priority) {
                switch (priority) {
                    case 'p1': return { icon: 'chevrons-up', text: t('highest'), badge: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' };
                    case 'p2': return { icon: 'chevron-up', text: t('high'), badge: 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300' };
                    case 'p3': return { icon: 'equal', text: t('medium'), badge: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' };
                    case 'p4': return { icon: 'chevron-down', text: t('low'), badge: 'bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-300' };
                    default: return { icon: 'equal', text: t('medium'), badge: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' };
                }
            }

            function getStatusInfo(status) {
                switch (status) {
                    case 'progress': return { text: t('kanban_progress'), badge: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' };
                    case 'done': return { text: t('kanban_done'), badge: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' };
                    case 'pending':
                    default: return { text: t('kanban_pending'), badge: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' };
                }
            }

            function updateStaticInterface() {
                // Sidebar Items
                if($('#nav-dashboard span')) $('#nav-dashboard span').textContent = t('dashboard');
                if($('#nav-tasks span')) $('#nav-tasks span').textContent = t('tasks');
                if($('#nav-projects span')) $('#nav-projects span').textContent = t('projects');
                if($('#nav-notes span')) $('#nav-notes span').textContent = t('notes');
                if($('#nav-calendar span')) $('#nav-calendar span').textContent = t('calendar');
                
                $$('.sidebar h1').forEach(el => el.textContent = "Headquarters"); 
                $$('.sidebar p').forEach(el => el.textContent = t('tagline'));
                
                const aiNav = document.querySelector('[data-iframe-title="AI Assistant"] span');
                if(aiNav) aiNav.textContent = t('ai_assistant');

                const settingsBtn = $('#settings-btn span');
                if(settingsBtn) settingsBtn.textContent = t('settings');

                // Footer
                const footerP = $('.section-footer p:first-child');
                if(footerP) footerP.innerHTML = `${t('developed_by')} <a href="https://bebelldigitalsolutions.com" target="_blank" class="hover:underline"><strong style="color:var(--primary);">Bebell Digital Solutions</strong></a>`;
                
                // Theme Toggle Text
                const isDark = document.documentElement.classList.contains('dark');
                const themeSpan = $('#theme-toggle span');
                if(themeSpan) themeSpan.textContent = isDark ? t('theme_dark') : t('theme_light');
            }

            function render() {
                updateStaticInterface(); 
                $$('.section').forEach(el => el.classList.add('hidden'));
                const activeSection = $(`#${state.activeView}`);
                if (activeSection) {
                    activeSection.classList.remove('hidden');
                }

                switch(state.activeView) {
                    case 'dashboard': renderDashboard(); break;
                    case 'tasks': renderTasks(); break;
                    case 'projects': renderProjects(); break;
                    case 'notes': renderNotes(); break;
                    case 'calendar': renderCalendar(); break;
                    case 'kanban-view':
                        if (state.activeProjectId) renderKanbanView(state.activeProjectId);
                        break;
                }
                if (window.lucide) {
                    lucide.createIcons();
                }
            }
            
            function renderDashboard() {
                // Translations for headers
                $('#dashboard h1').textContent = t('dashboard');
                $('#dashboard p').textContent = t('daily_summary');
                $('#btn-add-task').innerHTML = `<i data-lucide="plus-circle"></i> ${t('add_new_task')}`;
                $('#btn-add-note').innerHTML = `<i data-lucide="plus-circle"></i> ${t('add_quick_note')}`;
                $('#btn-add-project').innerHTML = `<i data-lucide="plus-circle"></i> ${t('add_new_project')}`;

                // Render Stats
                const statsContainer = $('#dashboard-stats');
                const pendingTasksCount = state.tasks.filter(t => !t.completed).length;
                const activeProjects = state.projects.length; 
                const totalNotes = state.notes.length;

                statsContainer.innerHTML = `
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full"><i data-lucide="list-checks" class="text-blue-500"></i></div>
                        <div><div class="text-2xl font-bold">${pendingTasksCount}</div><div class="text-gray-500 dark:text-gray-400">${t('pending_tasks')}</div></div>
                    </div>
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-full"><i data-lucide="folder-kanban" class="text-purple-500"></i></div>
                        <div><div class="text-2xl font-bold">${activeProjects}</div><div class="text-gray-500 dark:text-gray-400">${t('active_projects')}</div></div>
                    </div>
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded-full"><i data-lucide="notebook-pen" class="text-yellow-500"></i></div>
                        <div><div class="text-2xl font-bold">${totalNotes}</div><div class="text-gray-500 dark:text-gray-400">${t('total_notes')}</div></div>
                    </div>
                `;

                // Render Doughnut Chart
                const completedTasks = state.tasks.filter(t => t.completed).length;
                const pendingChartTasks = state.tasks.length - completedTasks;
                const totalTasks = state.tasks.length;
                
                if (taskCompletionChart) {
                    taskCompletionChart.destroy();
                }
                
                const chartCtx = $('#task-completion-chart').getContext('2d');
                
                const chartData = {
                    labels: [t('completed'), t('pending')],
                    datasets: [{
                        data: [completedTasks, pendingChartTasks],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderColor: document.documentElement.classList.contains('dark') ? '#2d3748' : '#ffffff',
                        borderWidth: 4
                    }]
                };

                const chartOptions = {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true,
                            position: 'bottom', 
                            labels: { color: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#333', padding: 20 }
                        },
                        tooltip: {
                            enabled: true
                        }
                    },
                    cutout: '70%'
                };

                if (totalTasks === 0) {
                    chartData.labels = ['No Tasks'];
                    chartData.datasets = [{
                        data: [1],
                        backgroundColor: [document.documentElement.classList.contains('dark') ? '#4a5568' : '#e5e7eb'],
                        borderColor: document.documentElement.classList.contains('dark') ? '#2d3748' : '#ffffff',
                        borderWidth: 4
                    }];
                    chartOptions.plugins.tooltip.enabled = false;
                    chartOptions.plugins.legend.display = false;
                }
                
                taskCompletionChart = new Chart(chartCtx, {
                    type: 'doughnut',
                    data: chartData,
                    options: chartOptions
                });

                // Update Section Headers
                $$('#dashboard h2').forEach(el => {
                    if(el.textContent.includes('Task Completion') || el.textContent.includes(t('task_completion'))) el.textContent = t('task_completion');
                    if(el.textContent.includes('Weekly Deadlines') || el.textContent.includes(t('weekly_deadlines'))) el.textContent = t('weekly_deadlines');
                    if(el.textContent.includes('Task Overview') || el.textContent.includes(t('task_overview'))) el.textContent = t('task_overview');
                    if(el.textContent.includes('Calendar Preview') || el.textContent.includes(t('calendar_preview'))) el.textContent = t('calendar_preview');
                });

                // Render Weekly Deadlines
                const weeklyDeadlinesContainer = $('#weekly-deadlines');
                if (weeklyDeadlinesContainer) {
                    const todayForWeek = new Date();
                    // Set to Sunday of the current week
                    const startOfWeek = new Date(todayForWeek.setDate(todayForWeek.getDate() - todayForWeek.getDay()));
                    startOfWeek.setHours(0, 0, 0, 0);

                    // Set to Saturday of the current week
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);

                    const thisWeeksTasks = state.tasks
                        .filter(t => 
                            !t.completed &&
                            t.dueDate &&
                            new Date(t.dueDate) >= startOfWeek &&
                            new Date(t.dueDate) <= endOfWeek
                        )
                        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                    let content;
                    if (thisWeeksTasks.length > 0) {
                        const locale = state.language === 'es' ? 'es-DO' : 'en-US';
                        const body = thisWeeksTasks.map((task) => {
                            const dueDate = new Date(task.dueDate);
                            const day = dueDate.toLocaleDateString(locale, { weekday: 'short' });
                            const date = dueDate.toLocaleDateString(locale, { day: '2-digit', month: '2-digit' });
                            return `
                                <div class="grid grid-cols-[50px_60px_1fr] gap-4 items-center py-2 px-2 border-b border-gray-200 dark:border-gray-700 last:border-b-0">
                                    <span class="font-semibold text-sm capitalize">${day.replace('.', '')}</span>
                                    <span class="text-sm text-gray-600 dark:text-gray-400">${date}</span>
                                    <span class="text-sm truncate" title="${task.title}">${task.title}</span>
                                </div>
                            `;
                        }).join('');

                        content = `<div class="mt-2">${body}</div>`;
                    } else {
                        content = `
                        <div class="flex flex-col items-center justify-center text-center py-8">
                            <i data-lucide="zap" class="w-16 h-16 text-gray-300 dark:text-gray-600 mb-4"></i>
                            <p class="text-gray-500">${t('no_deadlines')}</p>
                        </div>`;
                    }
                    weeklyDeadlinesContainer.innerHTML = content;
                }


                // Render Task Overview, sorted by priority
                const taskOverview = $('#dashboard-tasks');
                const incompleteTasks = state.tasks
                    .filter(t => !t.completed)
                    .sort((a, b) => (a.priority || 'p3').localeCompare(b.priority || 'p3'));
                
                if (incompleteTasks.length > 0) {
                    taskOverview.innerHTML = incompleteTasks
                        .slice(0, 5)
                        .map(t => {
                            const priorityInfo = getPriorityInfo(t.priority);
                            return `
                                <div class="py-3 border-b dark:border-gray-700 flex justify-between items-center">
                                    <span>${t.title}</span>
                                    <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${priorityInfo.badge}">
                                        <i data-lucide="${priorityInfo.icon}" class="w-3 h-3"></i>
                                        ${priorityInfo.text}
                                    </span>
                                </div>`;
                        })
                        .join('');
                } else {
                    taskOverview.innerHTML = `<p class="text-gray-500">${t('no_pending')}</p>`;
                }

                // Render Calendar Preview
                const calendarPreview = $('#dashboard-calendar-preview');
                const upcomingTasks = state.tasks
                    .filter(t => !t.completed && t.dueDate && new Date(t.dueDate) >= new Date())
                    .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate))
                    .slice(0, 3);
                if (upcomingTasks.length > 0) {
                    const locale = state.language === 'es' ? 'es-DO' : 'en-US';
                    calendarPreview.innerHTML = upcomingTasks
                        .map(t => `<div class="py-2 border-b dark:border-gray-700">${t.title} - <span class="text-sm text-gray-500">${new Date(t.dueDate).toLocaleDateString(locale)}</span></div>`)
                        .join('');
                } else {
                    calendarPreview.innerHTML = `<p class="text-gray-500">${t('no_upcoming')}</p>`;
                }
            }

            function renderTasks() {
                const list = $('#tasks-list');
                const filterContainer = $('#tasks-filter-container');

                // Headers and buttons
                $('#tasks h1').textContent = t('tasks');
                $('#add-task-from-view').innerHTML = `<i data-lucide="plus"></i> ${t('add_new_task')}`;

                // Render filter controls
                const allTags = [...new Set(state.tasks.flatMap(t => t.tags || []))].sort();
                filterContainer.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-grow">
                            <label for="task-search-input" class="sr-only">Search Tasks</label>
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                                <input id="task-search-input" type="search" placeholder="${t('search_placeholder')}" class="w-full p-2 pl-10 rounded-lg" value="${state.taskSearchQuery || ''}">
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center gap-2 flex-wrap">
                        <span class="font-semibold text-sm">${t('filter_tag')}</span>
                        ${allTags.length > 0 ? allTags.map(tag => `<button class="tag-filter-btn px-3 py-1 text-sm rounded-full ${state.activeTagFilter === tag ? 'btn-primary' : 'bg-gray-200 dark:bg-gray-700'}" data-tag="${tag}">${tag}</button>`).join('') : '<span class="text-sm text-gray-500">...</span>'}
                        ${state.activeTagFilter ? `<button id="clear-tag-filter-btn" class="text-sm text-red-500 hover:underline">${t('clear_filter')}</button>` : ''}
                    </div>
                `;

                // Filter tasks logic
                let filteredTasks = [...state.tasks];
                if (state.taskSearchQuery) {
                    const query = state.taskSearchQuery.toLowerCase();
                    filteredTasks = filteredTasks.filter(t => t.title.toLowerCase().includes(query) || (t.description && t.description.toLowerCase().includes(query)));
                }
                if (state.activeTagFilter) {
                    filteredTasks = filteredTasks.filter(t => t.tags && t.tags.includes(state.activeTagFilter));
                }
                
                const sortedTasks = filteredTasks.sort((a, b) => (a.priority || 'p3').localeCompare(b.priority || 'p3'));

                if(sortedTasks.length === 0) {
                    list.innerHTML = `<div class="card p-6 text-center text-gray-500">No tasks match your criteria.</div>`;
                    return;
                }
                
                const locale = state.language === 'es' ? 'es-DO' : 'en-US';

                list.innerHTML = sortedTasks.map(task => {
                    const priorityInfo = getPriorityInfo(task.priority);
                    const statusInfo = getStatusInfo(task.status);
                    const project = task.projectId ? state.projects.find(p=>p.id === task.projectId) : null;
                    return `
                    <div class="card p-4 flex items-start gap-4" data-task-id="${task.id}">
                        <button class="task-complete-btn mt-1 flex-shrink-0">
                            <i data-lucide="${task.completed ? 'check-circle-2' : 'circle'}" class="w-6 h-6 ${task.completed ? 'text-green-500' : 'text-gray-400'}"></i>
                        </button>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start gap-2">
                                <h3 class="font-bold text-lg ${task.completed ? 'line-through text-gray-500' : ''}">${task.title}</h3>
                                <div class="flex items-center flex-shrink-0 gap-2">
                                     <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusInfo.badge}">${statusInfo.text}</span>
                                    <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${priorityInfo.badge}">
                                        <i data-lucide="${priorityInfo.icon}" class="w-3 h-3"></i>
                                        ${priorityInfo.text}
                                    </span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">${task.description || ''}</p>
                            <div class="flex items-center gap-4 text-sm text-gray-500 mt-3 flex-wrap">
                                ${task.dueDate ? `<div class="flex items-center gap-1.5"><i data-lucide="calendar" class="w-4 h-4"></i> ${new Date(task.dueDate).toLocaleDateString(locale)}</div>` : ''}
                                ${project ? `<div class="flex items-center gap-1.5"><i data-lucide="folder-kanban" class="w-4 h-4"></i> ${project.name}</div>` : ''}
                                ${task.urgency ? `<div class="flex items-center gap-1.5 text-red-600"><i data-lucide="clock" class="w-4 h-4"></i> ${t('urgent')}</div>` : ''}
                                ${task.importance ? `<div class="flex items-center gap-1.5 text-yellow-600"><i data-lucide="alert-triangle" class="w-4 h-4"></i> ${t('important')}</div>` : ''}
                            </div>
                             ${task.tags && task.tags.length > 0 ? `<div class="mt-3 flex flex-wrap gap-2">${task.tags.map(tag => `<span class="bg-primary text-white text-xs px-2 py-1 rounded-full">${tag}</span>`).join('')}</div>` : ''}
                        </div>
                        <div class="flex-shrink-0 flex gap-1">
                            <button class="task-edit-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button class="task-delete-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                        </div>
                    </div>`
                }).join('');
            }

            function renderProjects() {
                const list = $('#projects-list');
                
                $('#projects h1').textContent = t('projects');
                $('#add-project-from-view').innerHTML = `<i data-lucide="plus"></i> ${t('add_new_project')}`;

                if(state.projects.length === 0) {
                    list.innerHTML = `<div class="card p-6 text-center text-gray-500 col-span-full">No projects yet. Add one to get started!</div>`;
                    return;
                }
                list.innerHTML = state.projects.map(p => `
                    <div class="card p-6 flex flex-col" data-project-id="${p.id}">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg mb-2 text-primary">${p.name}</h3>
                            <p class="text-gray-600 dark:text-gray-300 text-sm">${p.description || 'No description.'}</p>
                        </div>
                        <div class="mt-4 pt-4 border-t dark:border-gray-700 flex justify-end gap-2">
                             <button class="project-kanban-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" title="View Kanban">
                                <i data-lucide="layout-grid" class="w-4 h-4"></i>
                            </button>
                            <button class="project-edit-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" title="Edit Project">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button class="project-delete-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" title="Delete Project">
                                <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            function renderNotes() {
                const list = $('#notes-list');

                $('#notes h1').textContent = t('notes');
                $('#add-note-from-view').innerHTML = `<i data-lucide="plus"></i> ${t('add_quick_note')}`;

                if(state.notes.length === 0) {
                    list.innerHTML = `<div class="card p-6 text-center text-gray-500 col-span-full">No notes yet. Add one to get started!</div>`;
                    return;
                }
                list.innerHTML = state.notes.map(n => `
                    <div class="card p-6 flex flex-col" data-note-id="${n.id}">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg mb-2">${n.title}</h3>
                            <p class="text-gray-600 dark:text-gray-300 whitespace-pre-wrap text-sm">${n.content || ''}</p>
                        </div>
                        <div class="mt-4 pt-4 border-t dark:border-gray-700 flex justify-end gap-2">
                            <button class="note-edit-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button class="note-delete-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            function renderKanbanView(projectId) {
                const project = state.projects.find(p => p.id === projectId);
                if (!project) {
                    state.activeView = 'projects';
                    render();
                    return;
                }
                
                // Kanban headers
                const headings = $$('#kanban-view h2');
                if(headings.length === 3) {
                     headings[0].textContent = t('kanban_pending');
                     headings[1].textContent = t('kanban_progress');
                     headings[2].textContent = t('kanban_done');
                }
                $('#back-to-projects-btn span').textContent = t('back_to_projects');

                $('#kanban-project-title').textContent = project.name;

                const projectTasks = state.tasks.filter(t => t.projectId === projectId);
                const pendingCol = $('#kanban-pending');
                const progressCol = $('#kanban-progress');
                const doneCol = $('#kanban-done');

                // Clear columns before rendering
                pendingCol.innerHTML = '';
                progressCol.innerHTML = '';
                doneCol.innerHTML = '';

                projectTasks.forEach(task => {
                    const priorityInfo = getPriorityInfo(task.priority);
                    const taskCardHtml = `
                        <div class="kanban-task card p-3" draggable="true" data-task-id="${task.id}">
                            <h4 class="font-bold mb-1">${task.title}</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">${task.description || ''}</p>
                            <div class="flex justify-between items-center">
                                <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${priorityInfo.badge}">
                                    <i data-lucide="${priorityInfo.icon}" class="w-3 h-3"></i>
                                    ${priorityInfo.text}
                                </span>
                            </div>
                        </div>`;
                    switch (task.status) {
                        case 'progress':
                            progressCol.innerHTML += taskCardHtml;
                            break;
                        case 'done':
                            doneCol.innerHTML += taskCardHtml;
                            break;
                        case 'pending':
                        default:
                            pendingCol.innerHTML += taskCardHtml;
                            break;
                    }
                });

                if (window.lucide) {
                    lucide.createIcons();
                }
                setupKanbanEventListeners(projectId);
            }

            function updateCalendarViewToggle() {
                const monthBtn = $('#calendar-view-month');
                const weekBtn = $('#calendar-view-week');
                monthBtn.textContent = t('month');
                weekBtn.textContent = t('week');
                
                const activeClasses = ['bg-primary', 'text-white', 'shadow'];
                const inactiveClasses = ['opacity-60'];

                // Reset all classes first to handle theme changes properly
                monthBtn.classList.remove(...activeClasses, ...inactiveClasses, 'bg-white', 'dark:bg-gray-500');
                weekBtn.classList.remove(...activeClasses, ...inactiveClasses, 'bg-white', 'dark:bg-gray-500');
                
                if (document.documentElement.classList.contains('dark')) {
                    // Dark theme logic
                    const darkActive = ['bg-gray-500', 'shadow'];
                    const darkInactive = [];
                     if (state.calendarView === 'month') {
                        monthBtn.classList.add(...darkActive);
                        weekBtn.classList.add(...darkInactive);
                    } else {
                        weekBtn.classList.add(...darkActive);
                        monthBtn.classList.add(...darkInactive);
                    }
                } else {
                    // Light theme logic
                    if (state.calendarView === 'month') {
                        monthBtn.classList.add(...activeClasses);
                        weekBtn.classList.add(...inactiveClasses);
                    } else {
                        weekBtn.classList.add(...activeClasses);
                        monthBtn.classList.add(...inactiveClasses);
                    }
                }
            }

            function renderMonthlyCalendar() {
                const calContainer = $('#calendar-container');
                const calTitle = $('#calendar-title');
                const date = state.calendarDate;
                const locale = state.language === 'es' ? 'es-DO' : 'en-US';
                calTitle.textContent = date.toLocaleDateString(locale, { month: 'long', year: 'numeric' });

                const month = date.getMonth();
                const year = date.getFullYear();

                const firstDayOfMonth = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startingDay = firstDayOfMonth.getDay();

                let gridHtml = '<div class="calendar-grid">';
                const daysHeader = locale === 'es-DO' 
                    ? ['Dom','Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b'] 
                    : ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                
                daysHeader.forEach(day => {
                    gridHtml += `<div class="calendar-header">${day}</div>`;
                });

                for (let i = 0; i < startingDay; i++) {
                    gridHtml += '<div class="calendar-day other-month"></div>';
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDate = new Date(year, month, i);
                    dayDate.setHours(0, 0, 0, 0);
                    const tasksOnDay = state.tasks.filter(t => {
                        if (!t.dueDate) return false;
                        const taskDate = new Date(t.dueDate);
                        taskDate.setHours(0, 0, 0, 0);
                        return taskDate.getTime() === dayDate.getTime();
                    });

                    let tasksHtml = tasksOnDay.map(t => `<div class="calendar-task text-xs p-1 my-1 rounded-md truncate" title="${t.title}">${t.title}</div>`).join('');
                    
                    gridHtml += `<div class="calendar-day">
                        <div class="font-bold text-right">${i}</div>
                        ${tasksHtml}
                    </div>`;
                }
                gridHtml += '</div>';
                calContainer.innerHTML = gridHtml;
            }

            function renderWeeklyCalendar() {
                const calContainer = $('#calendar-container');
                const calTitle = $('#calendar-title');
                const date = new Date(state.calendarDate);
                const locale = state.language === 'es' ? 'es-DO' : 'en-US';

                // Find Sunday of the current week
                const firstDayOfWeek = new Date(date);
                firstDayOfWeek.setDate(date.getDate() - date.getDay());
                
                // Find Saturday of the current week
                const lastDayOfWeek = new Date(firstDayOfWeek);
                lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);

                const options = { month: 'long', day: 'numeric' };
                calTitle.textContent = `${firstDayOfWeek.toLocaleDateString(locale, options)} - ${lastDayOfWeek.toLocaleDateString(locale, { ...options, year: 'numeric' })}`;

                let gridHtml = '<div class="calendar-grid">';
                const daysHeader = locale === 'es-DO' 
                    ? ['Dom','Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b'] 
                    : ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

                daysHeader.forEach(day => {
                    gridHtml += `<div class="calendar-header">${day}</div>`;
                });

                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(firstDayOfWeek);
                    currentDay.setDate(firstDayOfWeek.getDate() + i);
                    currentDay.setHours(0, 0, 0, 0);
                    
                    const tasksOnDay = state.tasks.filter(t => {
                        if (!t.dueDate) return false;
                        const taskDate = new Date(t.dueDate);
                        taskDate.setHours(0, 0, 0, 0);
                        return taskDate.getTime() === currentDay.getTime();
                    });
                    
                    let tasksHtml = tasksOnDay.map(t => `<div class="calendar-task text-xs p-1 my-1 rounded-md truncate" title="${t.title}">${t.title}</div>`).join('');
                    
                    gridHtml += `<div class="calendar-day">
                        <div class="font-bold text-right">${currentDay.getDate()}</div>
                        ${tasksHtml}
                    </div>`;
                }
                gridHtml += '</div>';
                calContainer.innerHTML = gridHtml;
            }

            function renderCalendar() {
                $('#calendar h1').textContent = t('calendar');
                $('#sync-google-btn').innerHTML = `<i data-lucide="calendar-plus"></i> ${t('sync_google')}`;
                $('#download-ics-btn').innerHTML = `<i data-lucide="download-cloud"></i> ${t('download_ics')}`;
                
                const todayTasksContainer = $('#calendar-today-tasks');
                const todayHeader = $('#calendar .card h2'); // First card header
                if(todayHeader) todayHeader.textContent = t('todays_tasks');
                
                updateCalendarViewToggle();
                if (state.calendarView === 'month') {
                    renderMonthlyCalendar();
                } else {
                    renderWeeklyCalendar();
                }

                // Render Today's Tasks
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todaysTasks = state.tasks.filter(t => {
                    if (!t.dueDate) return false;
                    const taskDate = new Date(t.dueDate);
                    taskDate.setHours(0, 0, 0, 0);
                    return taskDate.getTime() === today.getTime();
                });
                
                if (todaysTasks.length > 0) {
                    todayTasksContainer.innerHTML = todaysTasks.map(t => `<div class="p-2 rounded-md ${t.completed ? 'bg-green-100 dark:bg-green-900' : 'bg-blue-100 dark:bg-blue-900'}">${t.title}</div>`).join('<div class="my-2"></div>');
                } else {
                    todayTasksContainer.innerHTML = `<p class="text-gray-500">${t('no_tasks_today')}</p>`;
                }
                if (window.lucide) {
                    lucide.createIcons();
                }
            }
            
            // --- MODAL & FORM LOGIC ---
            function openModal(title, content, setupCallback) {
                $('#modal-title').textContent = title;
                $('#modal-body').innerHTML = content;
                $('#modal-container').classList.remove('hidden');
                $('#modal-container').classList.add('flex');
                setTimeout(() => {
                    $('#modal-container').classList.remove('opacity-0');
                    $('#modal-content').classList.remove('-translate-y-10');
                }, 10);
                if (window.lucide) {
                    lucide.createIcons();
                }
                if (setupCallback) {
                    setupCallback();
                }
            }

            function closeModal() {
                $('#modal-content').classList.add('-translate-y-10');
                $('#modal-container').classList.add('opacity-0');
                setTimeout(() => {
                    $('#modal-container').classList.add('hidden');
                    $('#modal-container').classList.remove('flex');
                    $('#modal-body').innerHTML = ''; // Clear body to remove old listeners
                }, 300);
            }
            
            function showConfirmationModal(title, message, onConfirm) {
                const content = `
                    <p class="text-gray-600 dark:text-gray-300 mb-6">${message}</p>
                    <div class="flex justify-end gap-4">
                        <button id="modal-cancel-confirm" class="btn bg-gray-200 dark:bg-gray-600 dark:text-white">${t('cancel')}</button>
                        <button id="modal-confirm" class="btn bg-red-500 text-white">${t('confirm')}</button>
                    </div>
                `;
                openModal(title, content, () => {
                    $('#modal-confirm').addEventListener('click', () => {
                        onConfirm();
                        closeModal();
                    });
                    $('#modal-cancel-confirm').addEventListener('click', () => {
                        closeModal();
                    });
                });
            }

            function getTaskFormHtml(task = {}) {
                const isNew = !task.id;
                const projectsOptions = state.projects.map(p => `<option value="${p.id}" ${task.projectId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                return `
                    <form id="task-form" class="space-y-4" data-task-id="${task.id || ''}">
                        <div>
                            <label class="font-semibold block mb-1">${t('title')}</label>
                            <input name="title" required class="w-full p-2" value="${task.title || ''}">
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">${t('description')}</label>
                            <textarea name="description" class="w-full p-2" rows="3">${task.description || ''}</textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label class="font-semibold block mb-1">${t('due_date')}</label>
                                <input name="dueDate" type="date" class="w-full p-2" value="${task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : ''}">
                            </div>
                            <div>
                                <label class="font-semibold block mb-1">${t('project')}</label>
                                <select name="projectId" class="w-full p-2">
                                    <option value="">${t('none')}</option>
                                    ${projectsOptions}
                                </select>
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                             <div>
                                <label class="font-semibold block mb-1">${t('priority')}</label>
                                <select name="priority" class="w-full p-2">
                                   <option value="p1" ${task.priority === 'p1' ? 'selected' : ''}>ðŸ”¥ ${t('highest')}</option>
                                   <option value="p2" ${task.priority === 'p2' ? 'selected' : ''}>âš ï¸ ${t('high')}</option>
                                   <option value="p3" ${!task.priority || task.priority === 'p3' ? 'selected':''}>ðŸ”µ ${t('medium')}</option>
                                   <option value="p4" ${task.priority === 'p4' ? 'selected' : ''}>â¬‡ï¸ ${t('low')}</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-semibold block mb-1">${t('urgency')}</label>
                                <select name="urgency" class="w-full p-2">
                                   <option value="true" ${task.urgency ? 'selected' : ''}>â° ${t('urgent')}</option>
                                   <option value="false" ${!task.urgency ? 'selected' : ''}>${t('not_urgent')}</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-semibold block mb-1">${t('importance')}</label>
                                <select name="importance" class="w-full p-2">
                                   <option value="true" ${task.importance ? 'selected' : ''}>âš ï¸ ${t('important')}</option>
                                   <option value="false" ${!task.importance ? 'selected' : ''}>${t('not_important')}</option>
                                </select>
                            </div>
                        </div>
                         <div>
                            <label class="font-semibold block mb-1">${t('tags_label')}</label>
                            <input name="tags" class="w-full p-2" placeholder="e.g. work, personal, follow-up" value="${(task.tags || []).join(', ')}">
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="modal-cancel" class="btn bg-gray-200 dark:bg-gray-600 dark:text-white">${t('cancel')}</button>
                            <button type="submit" class="btn btn-primary">${isNew ? t('add') : t('save_changes')}</button>
                        </div>
                    </form>
                `;
            }

            function getProjectFormHtml(project = {}) {
                const isNew = !project.id;
                 return `
                    <form id="project-form" class="space-y-4" data-project-id="${project.id || ''}">
                        <div>
                            <label class="font-semibold block mb-1">${t('project_name')}</label>
                            <input name="name" required class="w-full p-2" value="${project.name || ''}">
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">${t('description')}</label>
                            <textarea name="description" class="w-full p-2" rows="4">${project.description || ''}</textarea>
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="modal-cancel" class="btn bg-gray-200 dark:bg-gray-600 dark:text-white">${t('cancel')}</button>
                            <button type="submit" class="btn btn-primary">${isNew ? t('add') : t('save_changes')}</button>
                        </div>
                    </form>
                `;
            }

            function getNoteFormHtml(note = {}) {
                const isNew = !note.id;
                 return `
                    <form id="note-form" class="space-y-4" data-note-id="${note.id || ''}">
                        <div>
                            <label class="font-semibold block mb-1">${t('title')}</label>
                            <input name="title" required class="w-full p-2" value="${note.title || ''}">
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">${t('content')}</label>
                            <textarea name="content" class="w-full p-2" rows="8">${note.content || ''}</textarea>
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="modal-cancel" class="btn bg-gray-200 dark:bg-gray-600 dark:text-white">${t('cancel')}</button>
                            <button type="submit" class="btn btn-primary">${isNew ? t('add') : t('save_changes')}</button>
                        </div>
                    </form>
                `;
            }
            
            async function handleFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                let item, storeName;

                switch(form.id) {
                    case 'task-form':
                        storeName = 'tasks';
                        const taskId = form.dataset.taskId;
                        const existingTask = taskId ? state.tasks.find(t => t.id === taskId) : {};
                        const tagsRaw = formData.get('tags') || '';
                        item = {
                            ...existingTask,
                            id: taskId || `task_${Date.now()}`,
                            createdAt: taskId ? existingTask.createdAt : Date.now(),
                            completed: existingTask.completed || false,
                            status: existingTask.status || 'pending',
                            title: formData.get('title'),
                            description: formData.get('description'),
                            dueDate: formData.get('dueDate') ? new Date(formData.get('dueDate')+'T00:00:00').getTime() : null,
                            projectId: formData.get('projectId'),
                            priority: formData.get('priority'),
                            urgency: formData.get('urgency') === 'true',
                            importance: formData.get('importance') === 'true',
                            tags: tagsRaw.split(',').map(t => t.trim()).filter(t => t),
                        };
                        break;
                    case 'project-form':
                        storeName = 'projects';
                        const projectId = form.dataset.projectId;
                        const existingProject = projectId ? state.projects.find(p => p.id === projectId) : {};
                        item = {
                            ...existingProject,
                            id: projectId || `project_${Date.now()}`,
                            createdAt: projectId ? existingProject.createdAt : Date.now(),
                            name: formData.get('name'),
                            description: formData.get('description'),
                        };
                        break;
                    case 'note-form':
                        storeName = 'notes';
                        const noteId = form.dataset.noteId;
                        const existingNote = noteId ? state.notes.find(n => n.id === noteId) : {};
                        item = {
                            ...existingNote,
                            id: noteId || `note_${Date.now()}`,
                            createdAt: noteId ? existingNote.createdAt : Date.now(),
                            title: formData.get('title'),
                            content: formData.get('content'),
                        };
                        break;
                }

                if(item && storeName) {
                    await dbService.add(storeName, item);
                    await refreshState();
                    render();
                    closeModal();
                }
            }

            // --- EVENT HANDLERS ---
            function handleNavClick(e) {
                const navItem = e.target.closest('.nav-item');
                if (!navItem) return;

                const contentIframe = $('#content-iframe');
                if (contentIframe && contentIframe.src !== 'about:blank') {
                    contentIframe.src = 'about:blank';
                }

                const view = navItem.dataset.view;
                const iframeUrl = navItem.dataset.iframeUrl;
                const iframeTitle = navItem.dataset.iframeTitle;

                if (iframeUrl) {
                    if (contentIframe) contentIframe.src = iframeUrl;
                    const iframeTitleEl = $('#iframe-title');
                    if (iframeTitleEl) iframeTitleEl.textContent = iframeTitle || 'External Content';
                }

                state.activeView = view;
                state.activeProjectId = null; 

                $$('.nav-item').forEach(el => el.classList.remove('active'));
                navItem.classList.add('active');

                render();
            }

            async function handleTaskActions(e) {
                const taskCard = e.target.closest('.card[data-task-id]');
                if (!taskCard) return;
                const taskId = taskCard.dataset.taskId;

                // Complete toggle
                if (e.target.closest('.task-complete-btn')) {
                    const task = state.tasks.find(t => t.id === taskId);
                    if(task) {
                        task.completed = !task.completed;
                        task.completedAt = task.completed ? Date.now() : null;
                        task.status = task.completed ? 'done' : 'pending'; // Sync status
                        await dbService.add('tasks', task);
                        await refreshState();
                        if (state.activeView === 'kanban-view' && state.activeProjectId) {
                           renderKanbanView(state.activeProjectId);
                        } else {
                           render();
                        }
                    }
                }
                
                // Edit button
                if (e.target.closest('.task-edit-btn')) {
                    const task = state.tasks.find(t => t.id === taskId);
                    if (task) {
                        openModal(t('edit'), getTaskFormHtml(task));
                    }
                }

                // Delete button
                if (e.target.closest('.task-delete-btn')) {
                    showConfirmationModal(t('delete'), t('delete_task_confirm'), async () => {
                        await dbService.delete('tasks', taskId);
                        await refreshState();
                        render();
                    });
                }
            }
            
            async function handleProjectActions(e) {
                const projectCard = e.target.closest('.card[data-project-id]');
                if (!projectCard) return;
                const projectId = projectCard.dataset.projectId;

                if (e.target.closest('.project-kanban-btn')) {
                    state.activeView = 'kanban-view';
                    state.activeProjectId = projectId;
                    render();
                }

                if (e.target.closest('.project-edit-btn')) {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        openModal(t('edit'), getProjectFormHtml(project));
                    }
                }

                if (e.target.closest('.project-delete-btn')) {
                    showConfirmationModal(t('delete'), t('delete_project_confirm'), async () => {
                        const tasksToUpdate = state.tasks.filter(t => t.projectId === projectId);
                        for (const task of tasksToUpdate) {
                            task.projectId = '';
                            await dbService.add('tasks', task);
                        }
                        await dbService.delete('projects', projectId);
                        await refreshState();
                        render();
                    });
                }
            }

            async function handleNoteActions(e) {
                const noteCard = e.target.closest('.card[data-note-id]');
                if (!noteCard) return;
                const noteId = noteCard.dataset.noteId;

                if (e.target.closest('.note-edit-btn')) {
                    const note = state.notes.find(n => n.id === noteId);
                    if (note) {
                        openModal(t('edit'), getNoteFormHtml(note));
                    }
                }

                if (e.target.closest('.note-delete-btn')) {
                       showConfirmationModal(t('delete'), t('delete_note_confirm'), async () => {
                        await dbService.delete('notes', noteId);
                        await refreshState();
                        render();
                    });
                }
            }
            
             function openSettingsModal() {
                const content = `
                    <div class="space-y-6">
                        <p class="text-gray-600 dark:text-gray-300">${t('settings_desc')}</p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-center border-b dark:border-gray-700 pb-6">
                            <label class="font-semibold">${t('language_label')}</label>
                            <select id="language-picker" class="w-full p-2 rounded-md">
                                <option value="en" ${state.language === 'en' ? 'selected' : ''}>English</option>
                                <option value="es" ${state.language === 'es' ? 'selected' : ''}>EspaÃ±ol</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-center">
                            <label class="font-semibold">${t('primary_color')}</label>
                            <div class="flex items-center gap-4">
                                <input type="color" id="primary-color-picker" value="${state.primaryColor}" class="h-10 w-16 p-1 rounded-md cursor-pointer">
                                <span id="primary-color-value" class="font-mono">${state.primaryColor}</span>
                            </div>
                        </div>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-center">
                            <label class="font-semibold">${t('secondary_color')}</label>
                            <div class="flex items-center gap-4">
                                <input type="color" id="secondary-color-picker" value="${state.secondaryColor}" class="h-10 w-16 p-1 rounded-md cursor-pointer">
                                <span id="secondary-color-value" class="font-mono">${state.secondaryColor}</span>
                            </div>
                        </div>
                        <div class="flex justify-end gap-4 pt-4 border-t dark:border-gray-700">
                             <button id="save-settings-btn" class="btn btn-primary">${t('save_changes')}</button>
                        </div>
                    </div>
                `;
                
                openModal(t('settings_title'), content, () => {
                    const primaryPicker = $('#primary-color-picker');
                    const secondaryPicker = $('#secondary-color-picker');
                    const languagePicker = $('#language-picker');

                    primaryPicker.addEventListener('input', (e) => {
                        applyColors(e.target.value, state.secondaryColor);
                        $('#primary-color-value').textContent = e.target.value;
                    });
                    secondaryPicker.addEventListener('input', (e) => {
                         applyColors(state.primaryColor, e.target.value);
                         $('#secondary-color-value').textContent = e.target.value;
                    });

                    // Save button
                    $('#save-settings-btn').addEventListener('click', () => {
                        state.language = languagePicker.value; // Update State
                        saveColorsToStorage(primaryPicker.value, secondaryPicker.value);
                        
                        // Save Language to LocalStorage
                        localStorage.setItem('headquarters-lang', state.language);
                        
                        closeModal();
                        const notification = $('#saveNotification');
                        notification.textContent = t('settings_saved');
                        notification.classList.add('show');
                        setTimeout(() => notification.classList.remove('show'), 3000);
                        
                        render(); // Re-render to apply language changes
                    });
                });
            }

            function openGoogleSyncModal() {
                const tasksWithDates = state.tasks.filter(t => t.dueDate);
                let modalContent;
                if (tasksWithDates.length > 0) {
                    modalContent = tasksWithDates.map(task => `
                        <div class="flex justify-between items-center p-3 border-b dark:border-gray-700">
                            <div>
                                <div class="font-semibold">${task.title}</div>
                                <div class="text-sm text-gray-500">${new Date(task.dueDate).toLocaleDateString(state.language === 'es' ? 'es-DO' : 'en-US')}</div>
                            </div>
                            <button class="add-to-google-btn btn btn-primary text-sm py-1 px-3" data-task-id="${task.id}">
                                <i data-lucide="plus" class="w-4 h-4"></i> Google
                            </button>
                        </div>
                    `).join('');
                } else {
                    modalContent = `<p class="text-gray-500 text-center p-4">You have no tasks with due dates to sync.</p>`;
                }
                openModal(t('sync_google'), modalContent);
            }

            function handleAddToGoogle(e) {
                const button = e.target.closest('.add-to-google-btn');
                if (!button) return;

                const taskId = button.dataset.taskId;
                const task = state.tasks.find(t => t.id === taskId);
                if (!task || !task.dueDate) return;

                function toGoogleDate(date) {
                    return new Date(date).toISOString().replace(/-|:|\.\d{3}/g, '').split('T')[0];
                }

                const googleDate = toGoogleDate(task.dueDate);

                const url = new URL('https://www.google.com/calendar/render');
                url.searchParams.set('action', 'TEMPLATE');
                url.searchParams.set('text', task.title);
                url.searchParams.set('dates', `${googleDate}/${googleDate}`); // All-day event
                url.searchParams.set('details', task.description || 'Task from Headquarters');
                
                window.open(url.toString(), '_blank');
            }

            function setupKanbanEventListeners(projectId) {
                const tasks = $$('#kanban-view .kanban-task');
                const columns = $$('#kanban-view .kanban-tasks-container');

                tasks.forEach(task => {
                    task.addEventListener('dragstart', (event) => {
                        task.classList.add('dragging');
                        event.dataTransfer.setData('text/plain', task.dataset.taskId);
                    });

                    task.addEventListener('dragend', () => {
                        task.classList.remove('dragging');
                    });
                });

                columns.forEach(col => {
                    col.addEventListener('dragover', event => {
                        event.preventDefault();
                        col.parentElement.classList.add('drag-over');
                    });

                    col.addEventListener('dragleave', () => {
                        col.parentElement.classList.remove('drag-over');
                    });

                    col.addEventListener('drop', async event => {
                        event.preventDefault();
                        col.parentElement.classList.remove('drag-over');
                        
                        const taskId = event.dataTransfer.getData('text/plain');
                        const task = state.tasks.find(t => t.id === taskId);
                        if (!task) return;

                        const newStatus = col.id.replace('kanban-', ''); // 'pending', 'progress', or 'done'
                        if (task.status !== newStatus) {
                            task.status = newStatus;
                            task.completed = (newStatus === 'done');
                            task.completedAt = task.completed ? Date.now() : null;

                            await dbService.add('tasks', task);
                            await refreshState();
                            renderKanbanView(projectId);
                        }
                    });
                });
            }

            function setupEventListeners() {
                // Navigation
                $('.sidebar nav').addEventListener('click', handleNavClick);
                
                // List actions (delegated)
                $('#tasks-list').addEventListener('click', handleTaskActions);
                $('#projects-list').addEventListener('click', handleProjectActions);
                $('#notes-list').addEventListener('click', handleNoteActions);
                $('#back-to-projects-btn').addEventListener('click', () => {
                    state.activeView = 'projects';
                    state.activeProjectId = null;
                    render();
                });

                // Task Filter actions (delegated)
                $('#tasks').addEventListener('input', e => {
                    if (e.target.id === 'task-search-input') {
                        state.taskSearchQuery = e.target.value;
                        renderTasks();
                    }
                });
                $('#tasks').addEventListener('click', e => {
                    if (e.target.matches('.tag-filter-btn')) {
                        const tag = e.target.dataset.tag;
                        state.activeTagFilter = state.activeTagFilter === tag ? null : tag;
                        renderTasks();
                    }
                    if (e.target.matches('#clear-tag-filter-btn')) {
                        state.activeTagFilter = null;
                        renderTasks();
                    }
                });

                // Theme & Settings
                $('#settings-btn').addEventListener('click', openSettingsModal);
                $('#theme-toggle').addEventListener('click', () => {
                    const html = document.documentElement;
                    html.classList.toggle('dark');
                    const isDark = html.classList.contains('dark');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    updateStaticInterface(); // updates the text
                    if (window.lucide) {
                        lucide.createIcons();
                    }
                    render(); 
                });

                // Modal Controls
                $('#modal-container').addEventListener('click', (e) => {
                    if (e.target.id === 'modal-container' || e.target.closest('#modal-close') || e.target.id === 'modal-cancel') {
                        closeModal();
                        loadColorsFromStorage(); // Revert to saved colors if modal is cancelled
                    }
                });
                $('#modal-body').addEventListener('click', handleAddToGoogle); // Delegated listener for google sync buttons

                document.addEventListener('submit', (e) => {
                    if (e.target.matches('#task-form, #project-form, #note-form')) {
                        handleFormSubmit(e);
                    }
                });
                
                // "Add" buttons
                $('#btn-add-task').addEventListener('click', () => openModal(t('add_new_task'), getTaskFormHtml()));
                $('#add-task-from-view').addEventListener('click', () => openModal(t('add_new_task'), getTaskFormHtml()));

                $('#btn-add-project').addEventListener('click', () => openModal(t('add_new_project'), getProjectFormHtml()));
                $('#add-project-from-view').addEventListener('click', () => openModal(t('add_new_project'), getProjectFormHtml()));
                
                $('#btn-add-note').addEventListener('click', () => openModal(t('add_quick_note'), getNoteFormHtml()));
                $('#add-note-from-view').addEventListener('click', () => openModal(t('add_quick_note'), getNoteFormHtml()));

                // Calendar Controls
                $('#calendar-prev').addEventListener('click', () => {
                    if (state.calendarView === 'month') {
                        state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
                    } else {
                        state.calendarDate.setDate(state.calendarDate.getDate() - 7);
                    }
                    renderCalendar();
                });
                $('#calendar-next').addEventListener('click', () => {
                    if (state.calendarView === 'month') {
                        state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
                    } else {
                        state.calendarDate.setDate(state.calendarDate.getDate() + 7);
                    }
                    renderCalendar();
                });
                $('#calendar-view-month').addEventListener('click', () => {
                    state.calendarView = 'month';
                    renderCalendar();
                });
                $('#calendar-view-week').addEventListener('click', () => {
                    state.calendarView = 'week';
                    renderCalendar();
                });

                // ICS Download & Google Sync
                $('#download-ics-btn').addEventListener('click', downloadICS);
                $('#sync-google-btn').addEventListener('click', openGoogleSyncModal);
            }

            function downloadICS() {
                let ics_content = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Headquarters//EN
`;
                state.tasks.forEach(task => {
                    if(task.dueDate) {
                        const startDate = new Date(task.dueDate).toISOString().replace(/-|:|\.\d\d\d/g,"");
                        ics_content += `BEGIN:VEVENT
UID:${task.id}@headquarters
DTSTAMP:${new Date().toISOString().replace(/-|:|\.\d\d\d/g,"")}
DTSTART;VALUE=DATE:${startDate.substring(0,8)}
SUMMARY:${task.title}
DESCRIPTION:${task.description || ''}
END:VEVENT
`
                    }
                });
                ics_content += 'END:VCALENDAR';

                const blob = new Blob([ics_content], {type: 'text/calendar;charset=utf-8'});
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "headquarters_tasks.ics";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }
            
            async function refreshState() {
                try {
                    [state.tasks, state.projects, state.notes] = await Promise.all([
                        dbService.getAll('tasks'),
                        dbService.getAll('projects'),
                        dbService.getAll('notes'),
                    ]);

                    // Migrate old tasks without a status
                    state.tasks = state.tasks.map(task => {
                        if (!task.status) {
                            task.status = task.completed ? 'done' : 'pending';
                        }
                        return task;
                    });

                    // Default sort can be by creation date
                    state.tasks.sort((a,b) => (a.createdAt > b.createdAt) ? -1 : 1);
                    state.projects.sort((a,b) => (a.createdAt > b.createdAt) ? -1 : 1);
                    state.notes.sort((a,b) => (a.createdAt > b.createdAt) ? -1 : 1);
                } catch(e) {
                    console.error("Could not update state from DB", e);
                }
            }

            // --- INITIALIZATION ---
            async function init() {
                // Set initial theme and colors
                loadColorsFromStorage();
                
                // Load Language
                const savedLang = localStorage.getItem('headquarters-lang');
                if (savedLang) state.language = savedLang;

                const theme = localStorage.getItem('theme');
                const isDark = theme === 'dark' || (theme === null && window.matchMedia('(prefers-color-scheme: dark)').matches);
                if (isDark) {
                    document.documentElement.classList.add('dark');
                }
                
                if (window.lucide) {
                   lucide.createIcons();
                }

                setupEventListeners();
                // Initialize Pomodoro
                pomodoro.init();
                
                try {
                    await dbService.init();
                    await refreshState();
                    render();
                } catch(e) {
                    console.error("Initialization failed", e);
                    $('main').innerHTML = `<div class="text-red-500 p-8">Error: Could not initialize the application. Please check the console for details.</div>`;
                }
            }

            document.addEventListener('DOMContentLoaded', init);

        })();
    </script>
</body>
</html>
